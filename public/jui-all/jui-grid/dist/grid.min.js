jui.define("grid.column",["jquery"],function(a){var b=function(b){this.element=null,this.order="asc",this.name=null,this.data=[],this.list=[],this.index=b,this.type="show",this.width=null,this.hide=function(){this.type="hide",a(this.element).hide()},this.show=function(){this.type="show",a(this.element).show()}};return b}),jui.define("grid.row",["jquery"],function(a){var b=function(){function b(a){for(var c=a.children,d=0;d<c.length;d++)c[d].setIndex(d),c[d].reload(),c[d].isLeaf()||b(c[d])}function c(b){b.list=[],a(b.element).find("td").each(function(a){b.list[a]=this,b.hidden[a]&&(this.style.display="none")})}function d(b){if(!b.tpl)return b.element;var c=a(b.tpl(a.extend({row:{type:b.type,index:b.index,data:b.data,depth:b.depth,children:b.children}},b.data))).get(0);return c}function e(b){a(b.element).remove();for(var c=0;c<b.children.length;c++){var d=b.children[c];d.isLeaf()?a(d.element).remove():e(d)}}function f(a){for(var b=0;b<a.length;b++)a[b].setIndex(b),a[b].reload()}this.setIndex=function(a){this.rownum=isNaN(a)?this.rownum:a,this.parent?this.index=this.parent.index+"."+this.rownum:this.index=""+this.rownum,this.parent&&"string"==typeof this.index&&(this.depth=this.index.split(".").length-1),this.isLeaf()||b(this)},this.reload=function(b){if(null!=this.element){var e=d(this),f=a(this.element).attr("class");a(e).addClass(f).insertAfter(this.element),a(this.element).remove(),this.element=e}else this.element=d(this);null!=b&&this.hideCells(b),c(this)},this.destroy=function(){null!=this.parent?this.parent.removeChild(this.index):(e(this),a(this.element).remove())},this.isLeaf=function(){return 0==this.children.length?!0:!1},this.fold=function(){this.type="fold";for(var b=0;b<this.children.length;b++){var c=this.children[b];a(c.element).hide(),c.isLeaf()||c.fold()}},this.open=function(){this.type="open";for(var b=0;b<this.children.length;b++){var c=this.children[b];a(c.element).show(),c.isLeaf()||c.open()}},this.appendChild=function(b){var c=this.isLeaf()?this.element:this.lastChildLeaf().element;a(b.element).insertAfter(c),this.children.push(b)},this.insertChild=function(b,c,d){var e=this.element;if(b>0){var g=this.children[b-1];e=g.isLeaf()&&this.children.length!=b+1?g.element:g.lastChildLeaf().element}a(c.element).insertAfter(e);var h=this.children.splice(0,b);h.push(c),this.children=h.concat(this.children),f(this.children)},this.removeChild=function(a){for(var b=0;b<this.children.length;b++){var c=this.children[b];c.index==a&&(this.children.splice(b,1),e(c))}f(this.children)},this.lastChild=function(){return this.isLeaf()?null:this.children[this.children.length-1]},this.lastChildLeaf=function(a){var b=a?a:this.lastChild();return b.isLeaf()?b:this.lastChildLeaf(b.lastChild())},this.showCell=function(b){this.hidden[b]=!1,a(this.list[b]).show()},this.hideCell=function(b){this.hidden[b]=!0,a(this.list[b]).hide()},this.hideCells=function(a){for(var b=0;b<a.length;b++)"hide"==a[b].type&&this.hideCell(b)}},c=function(){this.data=null,this.rownum=null,this.index=null,this.element=null,this.list=[],this.hidden={},this.parent=null,this.children=[],this.depth=0,this.type="fold",this.tpl=null,this.init=function(a,b,c){this.data=a,this.tpl=b,this.parent=c}};return c.prototype=new b,c}),jui.define("grid.base",["jquery","util.base","grid.column","grid.row"],function(a,b,c,d){var e=function(e,f){function g(){q(),h()}function h(){var b=[];t.thead.find("tr:last > th").each(function(a){b.push(this)});for(var d=0;d<b.length;d++){var e=new c(d);v[d]?(e.element=v[d].element,e.order=v[d].order,e.name=v[d].name,e.data=v[d].data,e.list=v[d].list,e.type=v[d].type,e.width=v[d].width):(e.element=b[d],(a(e.element).attr("width")||a(e.element).attr("style")&&-1!=a(e.element).attr("style").indexOf("width"))&&(e.width=a(e.element).outerWidth()),f&&f[d]&&(e.name=f[d]));for(var g=0;g<w.length;g++)e.list.push(w[g].list[d]),e.data.push(w[g].data[e.name]);v[d]=e}}function i(a,b){if("reload"==a||"append"==a)for(var c=0;c<v.length;c++)v[c].list[b.index]=b.list[c],v[c].data[b.index]=b.data[v[c].name];else if("remove"==a)for(var c=0;c<v.length;c++)v[c].list.splice(b.index,1),v[c].data.splice(b.index,1);else h()}function j(a,b,c){if(a instanceof d)return a;var e=new d;return e.init(a,u.row,c),e.setIndex(b),e.reload(v),e}function k(a,b){var c=b.children;if(c.length>0)for(var d=0;d<c.length;d++)a.push(c[d]),c[d].children.length>0&&k(a,c[d])}function l(){var a=arguments[0],b=arguments[1];"function"==typeof a?(b=a,a=0):a=isNaN(a)?0:a;for(var c=a;c<w.length;c++)w[c].setIndex(c),w[c].reload(),i("reload",w[c]),"function"==typeof b&&b(c)}function m(b,c){var d=j(c,b),e=d;if(w.length!=b||0==b&&1==w.length)a(d.element).insertBefore(w[b].element);else{var f=w[b-1];a(d.element).insertAfter(0==f.children.length?f.element:f.lastChildLeaf().element)}return e=w.splice(0,b),e.push(d),w=e.concat(w),l(b),d}function n(a,b){var c=z.getIndexList(a),d=s.getRowParent(a),e=c[c.length-1],f=j(b,e,d);return d.insertChild(e,f),f}function o(a){var b=j(a,w.length);return w.push(b),t.tbody.append(b.element),i("append",b),b}function p(a,b){var c=s.getRow(a),d=j(b,c.children.length,c);return c.appendChild(d),d}function q(){return"function"!=typeof u.none?!1:(y?w.length>0&&(t.tbody.find("tr:first").remove(),y=!1):0==w.length&&(t.tbody.html(u.none()),y=!0),!0)}function r(a){for(var b=0,c=w.length;c>b;b++)if(w[b].index==""+a)return w[b];return null}var s=this,t=e.$obj,u=e.$tpl,v=[],w=[],x={},y=!1,z=b.index();this.appendRow=function(){var a=arguments[0],b=arguments[1],c=null;return c=b?p(a,b):o(a),q(),c},this.insertRow=function(a,b){var c=null;return c=z.isIndexDepth(a)?n(a,b):0==w.length&&0==parseInt(a)?this.appendRow(b):m(a,b),q(),c},this.updateRow=function(a,b){var c=this.getRow(a);for(var d in b)c.data[d]=b[d];return c.reload(),i("reload",c),c},this.moveRow=function(a,c){if(a!=c){var d=this.getRowAll(a),e=d[0],f=b.clone(e.data);if(d.length>1)for(var g=0;g<d.length;g++){var a=z.changeIndex(d[g].index,c,d[0].index);this.insertRow(a,d[g].data)}else this.insertRow(c,f);this.removeRow(e.index)}},this.removeRow=function(a){var b=this.getRow(a);z.isIndexDepth(a)?b.destroy():(b.destroy(),i("remove",w[a]),w.splice(a,1),l(a)),q()},this.openRow=function(a){this.getRow(a).open(),x[a]=!1;for(var b in x)if(x[b]!==!1){var c=this.getRow(x[b]);null!=c&&c.fold()}},this.openRowAll=function(){for(var a=this.getRowAll(),b=0;b<a.length;b++)a[b].isLeaf()||(a[b].open(),x[a[b].index]=!1)},this.foldRow=function(a){this.getRow(a).fold(),x[a]=a},this.foldRowAll=function(){for(var a=this.getRowAll(),b=0;b<a.length;b++)a[b].isLeaf()||(a[b].fold(),x[a[b].index]=a[b].index)},this.removeRows=function(){w=[],q()||t.tbody.html(""),i()},this.sortRows=function(a,c){function d(b){var c=b.data[a];return"string"==typeof c?c.toLowerCase():isNaN(c)||null==c?"":c}var e=b.sort(w);c?e.setCompare(function(a,b){return d(a)>d(b)?!0:!1}):e.setCompare(function(a,b){return d(a)<d(b)?!0:!1}),e.run(),t.tbody.html(""),l(function(a){t.tbody.append(w[a].element)})},this.appendColumn=function(b,c){var d=v.length,e=a(u[b]({rows:c})),f=e.filter("thead").find("tr");f.each(function(b){var c=t.thead.find("tr").eq(b);a(this).find("th").each(function(a){c.append(this),f.size()-1==b&&v.push({element:this,list:[]})})});for(var g=0;g<w.length;g++)e.filter("tbody").find("tr").eq(g).find("td").each(function(b){a(w[g].element).append(this),v[d+b].list.push(this),w[g].list.push(this),a.extend(w[g].data,c[g])})},this.removeColumn=function(b){for(var c=0;c<v[b].list.length;c++)a(v[b].element).remove(),a(v[b].list[c]).remove();for(var d=0;d<w.length;d++)w[d].list.splice(b,1);v.splice(b,1)},this.hideColumn=function(a){if("hide"!=v[a].type){for(var b=this.getRowAll(),c=0;c<b.length;c++)b[c].hideCell(a);v[a].hide()}},this.showColumn=function(a){if("show"!=v[a].type){for(var b=this.getRowAll(),c=0;c<b.length;c++)b[c].showCell(a);v[a].show()}},this.getColumnCount=function(){return v.length},this.getRowCount=function(){return w.length},this.getColumn=function(a){return null==a?v:v[a]},this.getRow=function(a){if(null==a)return w;var b=r(a);if(b)return b;for(var c=z.getIndexList(a),b=r(c[0]),d=1,e=c.length;e>d&&b;d++)b=b.children[c[d]];return b},this.getRowAll=function(a){for(var b=[],c=null==a?w:[this.getRow(a)],d=0;d<c.length;d++)c[d]&&(b.push(c[d]),c[d].children.length>0&&k(b,c[d]));return b},this.getRowParent=function(a){return z.isIndexDepth(a)?this.getRow(z.getParentIndex(a)):null},this.setColumn=function(a,b){v[a]=b},this.setRow=function(a,b){w[a]=b},this.printInfo=function(){console.log(v),console.log(w)},g()};return e}),jui.defineUI("grid.table",["jquery","util.base","ui.dropdown","grid.base","grid.row"],function(a,b,c,d,e){b.resize(function(){for(var a=jui.get("grid.table"),b=0;b<a.length;b++)for(var c=a[b],d=0;d<c.length;d++)c[d].resize()},1e3);var f=function(){function f(a){return"<tr class='expand' style='display: none;'><td id='EXPAND_"+a.timestamp+"'></td></tr>"}function g(a,b){for(var c=[],d=0;d<b.length;d++)if("string"==typeof b[d]){var e=a.getColumn(b[d]);c.push(e.index)}else c.push(b[d]);return c}function h(b){var c=b.options.colshow,d=b.uit.getColumnCount();if(c===!0){b.options.colshow=c=[];for(var e=0;d>e;e++)c.push(e)}else c=g(b,c);for(var e=0;d>e;e++)-1==a.inArray(e,c)?b.uit.hideColumn(e):b.uit.showColumn(e)}function i(b){for(var d=b.listColumn(),e=[],f=0;f<d.length;f++)e.push(a(d[f].element).text());var g=a(b.tpl.menu({columns:e}));a("body").append(g),v=c(g,{close:!1}),a(v.root).find("input[type=checkbox]").each(function(c){"show"==d[c].type?this.checked=!0:this.checked=!1,b.addEvent(this,"click",function(d){var e=a(v.root).find("input[type=checkbox]:checked").size();this.checked?b.showColumn(c,d):e>0?b.hideColumn(c,d):this.checked=!0,b.hideExpand(),b.scroll()})})}function j(b){for(var c=u.table.outerWidth(),d=b.uit.getColumnCount(),e=!1,f=d-1;f>=0;f--){var g=b.getColumn(f),h=a(g.element).outerWidth();"none"==a(g.element).css("display")||e||(h-=t(),e=!0),a(g.list[0]).outerWidth(h)}u.tbody.outerWidth(c)}function k(b){a(b.root).hasClass("table-scroll")||b.scroll(),u.tbody.off("scroll").scroll(function(a){return u.tbody.scrollTop()+b.options.scrollHeight==u.tbody.get(0).scrollHeight?(b.emit("scroll",a),!1):void 0})}function l(a,b){a.uit.getRowCount()<1||(b&&(a.options.expand&&u.tbody.prepend(f(a)),a.scroll()),a.options.scroll&&k(a),a.setVo())}function m(a,b){for(var b=b?b:a.uit.getRow(),c=0;c<b.length;c++)!function(b){null!=b.element&&(b.children.length>0?(n(a,b),m(a,b.children)):n(a,b))}(b[c])}function n(b,c){function d(){return a("<tr class='dragline'><td colspan='"+c.list.length+"'></td></tr>")}function f(c){var d=a("<table id='TABLE_LAYER_"+b.timestamp+"' class='"+a(b.root).attr("class")+" layer'></table>"),e=a(c).clone();return d.css({position:"absolute",width:a(b.root).width(),display:"none"}),e.attr({"class":"dragclone"}),d.append(e),d}function g(c,d){if(u.tbody.find(".dragline").remove(),null!=y){if(a("#TABLE_LAYER_"+b.timestamp).remove(),y!=c&&b.emit("move",[b.get(y),d])!==!1){b.move(y,c);var e=b.get(c>y?c-1:c);a(e.element).addClass("dragtarget"),b.hideExpand(d),b.emit("moveend",[e,d])}y=null}}b.addEvent(c.element,"click",function(a){if(b.emit("select",[c,a]),b.emit("click",[c,a]),b.options.expand){if(b.options.expandEvent===!1)return;var d=z instanceof e?z:b.get(z);d===c?b.hideExpand(a):(null!=z&&b.hideExpand(a),b.showExpand(c,void 0,a))}}),b.addEvent(c.element,"dblclick",function(a){b.emit("dblclick",[c,a])}),b.addEvent(c.element,"contextmenu",function(a){return b.emit("rowmenu",[c,a]),!1}),b.options.editRow&&b.options.editEvent&&b.addEvent(c.element,"dblclick",function(a){("TD"==a.target.tagName||"TR"==a.target.tagName)&&b.showEditRow(c.index,a)}),b.options.moveRow&&(b.addEvent(c.element,"mousedown",function(b){null==y&&(y=c.index,u.tbody.find("tr").removeClass("dragtarget"),a(c.element).addClass("dragtarget"),a("body").append(f(c.element)))}),b.addEvent(c.element,"mouseover",function(a){null!=y&&(u.tbody.find(".dragline").remove(),d().insertBefore(c.element))}),b.addEvent(document,"mouseover",function(a){null!=y&&"TD"!=a.target.tagName&&"TR"!=a.target.tagName&&(u.tbody.find(".dragline").remove(),u.tbody.append(d()))}),b.addEvent(c.element,"mousemove",function(c){null!=y&&a("#TABLE_LAYER_"+b.timestamp).css({left:c.pageX+2,top:c.pageY+2,display:"table"})}),b.addEvent(c.element,"mouseup",function(a){g(c.index,a)}),b.addEvent(u.thead,"mouseover",function(a){g(0,a)}),b.addEvent(document,"mouseup",function(a){g(b.count(),a)}))}function o(b,c,d,e,f,h){function i(){null!=x&&h()}var j=b.getColumn(e),k=b.options.editRow,l=null;!j.name||k!==!0&&-1==a.inArray(e,g(b,k))?(l=a("<div class='edit'></div>").html(a(c).html()||"&nbsp;"),l.attr("disabled",!0)):l=a("<input type='text' class='edit' />").val(j.name?j.data[d.index]:""),a(c).html(l.css("width","100%")),f&&f.target==c&&l.focus(),b.addEvent(l,"keypress",function(a){13==a.which&&i()}),b.addEvent(u.tbody,"mousedown",function(a){("TD"==a.target.tagName||"TR"==a.target.tagName)&&i()})}function p(a){for(var b=a.options,c=a.uit.getColumnCount(),d=0;c>d;d++){var e=a.getColumn(d);!function(c,d){b.fields&&b.sort&&b.sortEvent===!0||a.addEvent(d.element,"click",function(b){a.emit("colclick",[d,b])}),a.addEvent(d.element,"dblclick",function(b){a.emit("coldblclick",[d,b])}),a.addEvent(d.element,"contextmenu",function(b){return a.emit("colmenu",[d,b]),!1})}(d,e)}}function q(b){for(var c=b.options.sort,d=c===!0?b.uit.getColumnCount():c.length,e=0;d>e;e++){var f=c===!0?e:c[e],g=b.getColumn(f);null!=g.element&&(!function(c,d){b.addEvent(d.element,"click",function(e){a(e.target).hasClass("resize")||(b.sort(c,void 0,e),b.emit("colclick",[d,e]))})}(f,g),a(g.element).css("cursor","pointer"))}}function r(b){function c(c){for(var d=c+1;d<b.uit.getColumnCount();d++){var e=b.getColumn(d).element;if(!a(e).is(":hidden"))return b.getColumn(d)}}function d(b,c){var d=30;if(!(d>i+c||d>j-c)&&(a(g.element).outerWidth(i+c),a(h.element).outerWidth(j-c),b.options.scroll)){var e=a(h.element).outerWidth()-(g.index==b.uit.getColumnCount()-2?t():0);a(g.list[0]).outerWidth(a(g.element).outerWidth()),a(h.list[0]).outerWidth(e)}}var e=0,f=u.table.offset(),g=null,h=null,i=0,j=0,k=null;u.thead.find(".resize").remove();for(var l=0;l<b.uit.getColumnCount()-1;l++){var m=a(b.getColumn(l).element),n=a("<div class='resize'></div>"),o=m.offset();n.css({position:"absolute",width:"8px",height:m.outerHeight(),left:m.outerWidth()+(o.left-f.left)-1+"px",top:o.top-f.top+"px",cursor:"w-resize","z-index":"1"}),m.append(n),function(d){b.addEvent(n,"mousedown",function(f){return 0==e&&(e=f.pageX),g=b.getColumn(d),h=c(d),i=a(g.element).outerWidth(),j=a(h.element).outerWidth(),k=this,B=!0,!1})}(l)}b.addEvent(document,"mousemove",function(a){e>0&&d(b,a.pageX-e)}),b.addEvent(document,"mouseup",function(c){if(e>0){e=0;var d=a(g.element).offset().left-f.left;return a(k).css("left",a(g.element).outerWidth()+d-1),b.emit("colresize",[g,c]),setTimeout(function(){B=!1},100),!1}})}function s(a,b){a.hideExpand(),a.hideEditRow(),a.unselect(),b||a.uncheckAll()}function t(){return a(".jui").size()>0&&b.browser.webkit?10:b.scrollWidth()}var u=null,v=null,w=null,x=null,y=null,z=null,A={},B=!1;this.init=function(){var b=this.options;if(b.data=null!=b.rows?b.rows:b.data,u={table:a(this.root).css({position:"relative"}),thead:a(this.root).find("thead"),tbody:a(this.root).find("tbody")},this.uit=new d({$obj:u,$tpl:this.tpl},b.fields),b.moveRow&&u.tbody.css({"-webkit-user-select":"none","-moz-user-select":"none","-ms-user-select":"none","-o-user-select":"none","user-select":"none"}),b.fields&&b.colshow&&h(this),b.fields&&this.tpl.menu&&null!=c&&i(this),b.resize&&r(this),b.fields&&b.sort&&b.sortEvent===!0&&q(this),b.data.length>0?this.update(b.data):this.setVo(),b.width>0&&u.table.outerWidth(b.width),!b.fields&&(b.sort||b.colshow||b.editRow))throw new Error("JUI_CRITICAL_ERR: 'fields' option is required");p(this)},this.update=function(){var a=1==arguments.length?arguments[0]:arguments[1],b=2==arguments.length?arguments[0]:null;if(null!=b){var c=this.uit.updateRow(b,a);n(this,c),0==parseInt(b)&&this.scroll()}else this.uit.removeRows(),this.scroll(),this.append(a),this.options.sortIndex&&this.sort(this.options.sortIndex,this.options.sortOrder,null)},this.updateTree=function(a){var c=b.index();this.uit.removeRows();for(var d=0;d<a.length;d++){var e=c.getParentIndex(a[d].index);null==e?this.uit.appendRow(a[d].data):this.uit.appendRow(e,a[d].data)}l(this,!0),m(this)},this.append=function(){var a=this.count()>0?!1:!0,b=1==arguments.length?arguments[0]:arguments[1],c=2==arguments.length?arguments[0]:null;b=void 0==b.length?[b]:b;for(var d=0;d<b.length;d++){var e=null;e=null!=c?this.uit.appendRow(c,b[d]):this.uit.appendRow(b[d]),a||n(this,e)}l(this,a),a&&m(this)},this.insert=function(a,b){for(var c=this.count()>0?!1:!0,b=void 0==b.length?[b]:b,d=0;d<b.length;d++)this.uit.insertRow(a,b[d]);l(this,c),m(this)},this.select=function(b){s(this);var c=this.get(b);return a(c.element).parent().find(".selected").removeClass("selected"),a(c.element).addClass("selected"),w=b,c},this.unselect=function(){if(null!=w){var b=this.get(w);return a(b.element).removeClass("selected"),w=null,b}},this.check=function(b){s(this,!0);var c=this.get(b);this.hideExpand(),this.hideEditRow(),this.unselect(),A[b]=c,a(c.element).addClass("checked")},this.uncheck=function(b){if(null!=A[b]){var c=this.get(b);A[b]=null,a(c.element).removeClass("checked")}},this.uncheckAll=function(){A={},u.tbody.find(".checked").removeClass("checked")},this.remove=function(a){return null==a?null:(this.uit.removeRow(a),m(this),void this.scroll())},this.reset=function(){w=null,z=null,x=null,y=null,A={},this.uit.removeRows(),this.scroll()},this.move=function(a,b){this.uit.moveRow(a,b),m(this),(0==parseInt(a)||0==parseInt(b))&&this.scroll()},this.sort=function(a,b,c){if(this.options.fields&&this.options.sort&&!B){var d=this.getColumn(a);"string"==typeof d.name&&(d.order=b?b:"asc"==d.order?"desc":"asc",this.uit.setColumn(a,d),this.uit.sortRows(d.name,"desc"==d.order?!0:!1),this.emit("sort",[d,c]),l(this,!0),m(this))}},this.scroll=function(a){if(this.options.scroll){var b=this,c=a&&a>0?a:this.options.scrollHeight,c=c>0?c:200;this.options.scrollHeight=c,u.tbody.css("maxHeight",c+"px"),setTimeout(function(){u.tbody.outerHeight()<c?(u.table.css({"table-layout":""}),u.tbody.css({display:"",overflow:""})):(u.table.css({"table-layout":"fixed"}),u.tbody.css({display:"block",overflow:"auto"})),j(b)},10)}},this.open=function(a){null!=a&&(this.uit.openRow(a),this.emit("open",[this.get(a)]))},this.fold=function(a){null!=a&&(this.uit.foldRow(a),this.emit("fold",[this.get(a)]))},this.openAll=function(){this.uit.openRowAll(),this.emit("openall")},this.foldAll=function(){this.uit.foldRowAll(),this.emit("foldall")},this.resize=function(){this.scroll(),this.options.resize&&r(this)},this.resizeColumns=function(){for(var b=this.listColumn(),c=0;c<b.length;c++)null==b[c].width&&a(b[c].element).outerWidth("auto")},this.size=function(){return this.uit.getRowCount()},this.count=function(){return this.uit.getRowCount()},this.list=function(){return this.uit.getRow()},this.listData=function(){for(var a=this.list(),b=[],c=0;c<a.length;c++)b.push(a[c].data);return b},this.listAll=function(){return this.uit.getRowAll()},this.listChecked=function(){var a=[];for(var b in A)null!=A[b]&&a.push(A[b]);return a},this.listColumn=function(){return this.uit.getColumn()},this.get=function(a){return null==a?null:this.uit.getRow(a)},this.getAll=function(a){return null==a?null:this.uit.getRowAll(a)},this.getColumn=function(b){return null==b?null:"string"==typeof b?this.uit.getColumn(a.inArray(b,this.options.fields)):this.uit.getColumn(b)},this.showColumn=function(a,b){if(this.options.fields){var c=this.getColumn(a);this.uit.showColumn(c.index),this.scroll(),this.resizeColumns(),this.options.resize&&r(this),this.emit("colshow",[c,b])}},this.hideColumn=function(a,b){if(this.options.fields){var c=this.getColumn(a);this.uit.hideColumn(c.index),this.scroll(),this.resizeColumns(),this.options.resize&&r(this),this.emit("colhide",[c,b])}},this.initColumns=function(a){"object"==typeof a&&(this.options.colshow=a,h(this),this.scroll(),this.resizeColumns(),this.options.resize&&r(this))},this.showColumnMenu=function(c,d){if(this.options.fields&&v){var e=this.listColumn(),f=u.thead.offset(),g=b.typeCheck("integer",c)?c:0,h=b.typeCheck("integer",d)?d:f.top+u.thead.outerHeight();a(v.root).find("input[type=checkbox]").each(function(a){"show"==e[a].type?this.checked=!0:this.checked=!1}),v.move(g,h),v.show()}},this.hideColumnMenu=function(){this.options.fields&&v&&v.hide()},this.toggleColumnMenu=function(a,b){this.options.fields&&v&&("show"==v.type?this.hideColumnMenu():this.showColumnMenu(a,b))},this.showExpand=function(b,c,d){if(this.options.expand){s(this);var f="#EXPAND_"+this.timestamp,g=b instanceof e?b:this.get(b),c="object"!=typeof c?a.extend({row:g},g.data):c,h=a(f).parent().show();u.tbody.find("tr").removeClass("open"),h.insertAfter(a(g.element).addClass("open")),a(f).attr("colspan",u.thead.find("tr:last > th:visible").size()).html(this.tpl.expand(c)),this.scroll(),this.setVo(),z=b,this.emit("expand",[g,d])}},this.hideExpand=function(b){if(null!=z){var c=z instanceof e?z:this.get(z);a("#EXPAND_"+this.timestamp).parent().hide(),u.tbody.find("tr").removeClass("open"),this.scroll(),z=null,this.emit("expandend",[c,b])}},this.getExpand=function(){return null==z?null:z instanceof e?z:this.get(z)},this.showEditRow=function(b,c){if(this.options.editRow){s(this);var d=this,e=this.get(b),f=a(e.element).find("td");f.each(function(b){o(d,this,e,b,c,function(){var b={},g=e.data;f.each(function(c){var e=d.getColumn(c);if(null!=e.name){var f=a(this).find("input.edit");if(1==f.size()){var g=f.val();b[e.name]=isNaN(g)||null==g||""==g?g:parseFloat(g)}}}),e.data=a.extend(e.data,b);var h=d.emit("editend",[e,c]);h!==!1?d.hideEditRow(b):e.data=g})}),x=b,d.emit("editstart",[e,c])}},this.hideEditRow=function(a){if(null!=x){var b=this.get(x);x=null,this.update(b.index,a?a:b.data)}},this.getEditRow=function(){return null==x?null:this.get(x)},this.setCsv=function(){var a=this.options;if(a.fields||a.csv){var c=1==arguments.length?arguments[0]:arguments[1],d=2==arguments.length?arguments[0]:null,e=b.getCsvFields(a.fields,a.csv),f=a.csvNumber?b.getCsvFields(a.fields,a.csvNumber):null,g=b.csvToData(e,c,f);if(null==d)this.update(g);else{this.reset();for(var h=0;h<g.length;h++){var i=g[h][d];i&&this.insert(i,g[h])}}}},this.setCsvFile=function(){if(this.options.fields||this.options.csv){var a=this,c=1==arguments.length?arguments[0]:arguments[1],d=2==arguments.length?arguments[0]:null;b.fileToCsv(c,function(b){null==d?a.setCsv(b):a.setCsv(d,b)})}},this.getCsv=function(a){if(this.options.fields||this.options.csv){for(var c=b.getCsvFields(this.options.fields,this.options.csv),d=[],e=a?this.listAll():this.list(),f=0;f<e.length;f++)d.push(e[f].data);return b.dataToCsv2({fields:c,rows:d,names:this.options.csvNames})}},this.getCsvBase64=function(a){return this.options.fields||this.options.csv?b.csvToBase64(this.getCsv(a)):void 0},this.downloadCsv=function(a,c){b.typeCheck("string",a)&&(a=a.split(".")[0]);var d=document.createElement("a");d.download=a?a+".csv":"table.csv",d.href=this.getCsvBase64(c),document.body.appendChild(d),d.click(),d.parentNode.removeChild(d)},this.activeIndex=function(){return null!=z?z instanceof e?z.index:z:w||x}};return f.setup=function(){return{fields:null,csv:null,csvNames:null,csvNumber:null,data:[],rows:null,colshow:!1,scroll:!1,scrollHeight:200,width:0,expand:!1,expandEvent:!0,editRow:!1,editEvent:!0,resize:!1,sort:!1,sortIndex:null,sortOrder:"asc",sortEvent:!0,moveRow:!1,animate:!1}},f}),jui.defineUI("grid.xtable",["jquery","util.base","ui.modal","grid.table","grid.row"],function(a,b,c,d,e){b.resize(function(){for(var a=jui.get("grid.xtable"),b=0;b<a.length;b++)for(var c=a[b],d=0;d<c.length;d++)c[d].resize()},1e3);var f=function(){function f(a,b,c,d){for(var f=[],g=0,h=a.length;h>g;g++){var i=new e,j=b+g;i.init(a[g],s.tpl.row,c),i.setIndex(j),("open"==d||"fold"==d)&&(i.type=d),null==c&&(v[j]=i),f.push(i)}return f}function g(b){function c(b,c){var d={};for(var e in b.options)-1==a.inArray(e,c)&&(d[e]=b.options[e]);return b.options.scrollWidth>0&&(d.resize=!1),d}function e(b,c,d){var e=b.options;e.scrollWidth>0?b.scrollWidth(e.scrollWidth,!0):e.width>0&&a(b.root).outerWidth(e.width)}function f(b,c){a(c.root).wrap("<div class='head'></div>"),a(c.root).children("tbody").remove()}function g(b,c){var d=c.listColumn();if("page"!=b.options.buffer){var e=b.options.scrollHeight;"vscroll"==b.options.buffer?(a(c.root).wrap("<div class='body' style='max-height: "+e+"px'><div></div></div>"),a(c.root).parent().parent().css({"overflow-y":"scroll"})):(a(c.root).wrap("<div class='body' style='max-height: "+e+"px'></div>"),a(c.root).parent().css({"overflow-y":"scroll"}))}else a(c.root).wrap("<div class='body'></div>");a(c.root).find("thead > tr").outerHeight(0).not(":last-child").remove();for(var f=0;f<d.length;f++)a(d[f].element).html("").outerHeight(0)}var h=["buffer","bufferCount","csvCount","sortLoading","sortCache","sortIndex","sortOrder","event","rows","scrollWidth","width","rowHeight"],i=a(b.root);"vscroll"==b.options.buffer&&(i.hasClass("nowrap")||i.addClass("nowrap")),i.append(i.children("table").clone()),s=d(i.children("table:first-child"),c(b,h)),f(b,s),t=d(i.children("table:last-child"),c(b,h.concat("resize"))),g(b,t),e(b,s,t)}function h(c){s.on("colresize",function(d,e){for(var f=s.listColumn(),g=t.listColumn(),h=!1,i=f.length-1;i>=0;i--){var j=a(f[i].element).outerWidth();"page"==c.options.buffer||"show"!=f[i].type||h?(a(f[i].element).outerWidth(j),a(g[i].element).outerWidth(j)):(b.browser.msie?a(g[i].element).outerWidth(j-l(c)):a(g[i].element).css({width:"auto"}),h=!0)}k(500),c.emit("colresize",[d,e])}),s.on("colshow",function(a,b){t.uit.showColumn(a.index),c.resize(),c.emit("colshow",[a,b])}),s.on("colhide",function(a,b){t.uit.hideColumn(a.index),c.resize(),c.emit("colhide",[a,b])}),s.on("colclick",function(a,b){c.emit("colclick",[a,b])}),s.on("coldblclick",function(a,b){c.emit("coldblclick",[a,b])}),s.on("colmenu",function(a,b){c.emit("colmenu",[a,b])}),s.on("sort",function(a,b){c.sort(a.index,a.order,b),c.emit("sort",[a,b]),c.options.sortCache&&c.setOption({sortIndex:a.index,sortOrder:a.order})}),t.on("select",function(a,b){c.emit("select",[a,b])}),t.on("click",function(a,b){c.emit("click",[a,b])}),t.on("dblclick",function(a,b){c.emit("dblclick",[a,b])}),t.on("rowmenu",function(a,b){c.emit("rowmenu",[a,b])}),t.on("expand",function(a,b){c.emit("expand",[a,b])}),t.on("expandend",function(a,b){c.emit("expandend",[a,b])})}function i(b,c,d){var e=b.options,f=a(b.root).children(".head"),g=a(b.root).children(".body");b.addEvent(g,"scroll",function(a){return b.hideColumnMenu(),c>0&&f.scrollLeft(this.scrollLeft),"scroll"==e.buffer?this.scrollTop+d>=g.get(0).scrollHeight&&(b.next(),b.emit("scroll",a)):"vscroll"==e.buffer&&(F.prev_scroll_left==this.scrollLeft?(m(b),b.next(),b.emit("scroll",a)):F.prev_scroll_left=this.scrollLeft),!1}),"vscroll"==e.buffer&&(a(b.root).hover(function(){F.is_focus=!0},function(){F.is_focus=!1}),b.addEvent(document,"keydown",function(a){if(F.is_focus){var c=g.scrollTop(),d=b.options.rowHeight;if(38==a.which||40==a.which)g.scrollTop(c+(38==a.which?-d:d));else if(33==a.which||34==a.which){var e=d*F.scroll_count;g.scrollTop(c+(33==a.which?-e:e))}}}))}function j(b){function c(b){var c=30;e.head+b<e["max-width"]||e.column+b<c||(a(d.head.element).outerWidth(e.column+b),a(d.body.element).outerWidth(e.column+b),a(s.root).outerWidth(e.head+b),a(t.root).outerWidth(e.body+b))}var d={},e={},f=0;a(b.root).find("thead .resize").remove();for(var g=0,h=s.uit.getColumnCount();h>g;g++){var i=a(s.getColumn(g).element),j=a("<div class='resize'></div>"),l=i.position(),m=i.outerWidth()+l.left-1;j.css({position:"absolute",width:C+"px",height:i.outerHeight(),left:(g==h-1?m-C:m)+"px",top:l.top+"px",cursor:"w-resize","z-index":"1"}),i.append(j),function(c,g){b.addEvent(j,"mousedown",function(b){return 0==f&&(f=b.pageX),d={head:s.getColumn(c),body:t.getColumn(c),isLast:g},e={column:a(d.head.element).outerWidth(),head:a(s.root).outerWidth(),body:a(t.root).outerWidth(),"max-width":parseInt(a(s.root).parent().css("max-width"))},B=!0,!1})}(g,g==h-1)}b.addEvent(document,"mousemove",function(a){f>0&&c(a.pageX-f)}),b.addEvent(document,"mouseup",function(b){if(f>0){if(d.isLast){var c=a(t.root).parent().scrollLeft(),e=b.pageX-f;e>0&&(a(s.root).parent().scrollLeft(c+e),a(t.root).parent().scrollLeft(c+e))}return f=0,k(500),s.emit("colresize",[d.head,b]),setTimeout(function(){B=!1},100),!1}}),s.on("colshow",k),s.on("colhide",k)}function k(b){setTimeout(function(){for(var b=0,c=s.uit.getColumnCount();c>b;b++){var d=a(s.getColumn(b).element),e=d.position(),f=d.outerWidth()+e.left-1;d.find(".resize").css("left",(b==c-1?f-C:f)+"px")}},b)}function l(a){return"page"==a.options.buffer?0:b.scrollWidth()+1}function m(b){var c=a(b.root).children(".body"),d=b.options.scrollHeight,e=c.scrollTop(),f=c[0].scrollHeight,g=F.prev_scroll_top-e;if(0!=g){var h=!1;if(Math.abs(g)<d){if(h=!0,0!==g){if(g<F.height)var i=Math.ceil(Math.abs(g)/F.height);else var i=Math.floor(Math.abs(g)/F.height);g>0?F.current_row_index-=i:F.current_row_index+=i}}else{var j=e/(f-d),k=Math.floor(F.count-F.scroll_count);F.current_row_index=Math.ceil(k*j)}for(var l=F.current_row_index,m=l,n=F.height;d>n&&m<F.count;)m++,n+=F.height;if(d>n)if(d>F.content_height);else{var o=Math.ceil(Math.abs(d-n)/F.height);l-=o,n+=o*F.height}if(0>l)return void(F.prev_scroll_top=0);h&&m!==F.count-1&&(e=Math.ceil(l/F.count*f),c.scrollTop(e));var p=0;e>=f-(d+17)&&n>d+17&&(p=-Math.abs(n-(d+17))),F.prev_scroll_top=e,c.css({"max-height":n}),a(t.root).css({top:F.prev_scroll_top+p+"px"}),F.start_index=l,F.end_index=m+1}}function n(b){F.height=b.options.rowHeight,F.count=w.length,F.scroll_count=Math.floor(b.options.scrollHeight/F.height),F.content_height=F.count*F.height,a(t.root).parent().height(F.content_height>0?F.content_height:"auto")}function o(b){a(b.root).find(".body").scrollTop(0),a(t.root).css({top:"0px"}),F={height:0,content_height:0,count:0,scroll_count:0,prev_scroll_left:0,prev_scroll_top:0,current_row_index:0,start_index:0,end_index:0,is_focus:!0}}function p(a){for(var b=0;b<a.length;b++)w.push(a[b]),"open"==a[b].type&&a[b].children.length>0&&p(a[b].children)}function q(a,c,d){for(var e=a.children.length,g=f(b.typeCheck("array",c)?c:[c],e,a,d),h=0,i=g.length;i>h;h++)a.children.push(g[h])}function r(a,b){b?(w=[],p(u)):w=u,"vscroll"==a.options.buffer&&n(a)}var s=null,t=null,u=[],v=[],w=[],x=null,y=null,z=1,A=!1,B=!1,C=8,D=null,E=b.index(),F=null;this.init=function(){var b=this.options;if(b.data=null!=b.rows?b.rows:b.data,"TABLE"==this.root.tagName){var d=a(this.root).wrap("<div class='xtable'></div>");this.root=d.parent().get(0)}if(g(this),h(this),i(this,b.scrollWidth,b.scrollHeight),b.data&&this.update(b.data),s.tpl.loading&&null!=c){var e=a(s.tpl.loading());a(this.root).append(e),y=c(e,{target:this.selector,opacity:.1,autoHide:!1}),b.sortLoading=b.sortLoading===!0?500:b.sortLoading}b.resize&&(b.scrollWidth>0?j(this):(s.resizeColumns(),s.resize()))},this.render=function(a){r(this,a),this.next()},this.select=function(b){null!=D&&a(D.element).removeClass("selected");var c=this.get(b);return D=c,null!=c.element&&a(c.element).addClass("selected"),c},this.unselect=function(){null!=D&&(a(D.element).removeClass("selected"),D=null)},this.update=function(a){this.reset(),u=f(a,0,null),this.render(),this.emit("update"),s.emit("colresize"),this.options.sortIndex&&this.sort(this.options.sortIndex,this.options.sortOrder,void 0,!0)},this.updateTree=function(a){this.reset();for(var b=0;b<a.length;b++){var c=E.getParentIndex(a[b].index);if(null==c)u.push(f([a[b].data],0,null,a[b].type)[0]);else{var d=this.get(c);d&&q(d,a[b].data,a[b].type)}}this.render(!0),this.emit("updateTree")},this.append=function(a,b){var c=this.get(a);c&&(q(c,b),this.clear(),this.render(!0),
this.emit("append"))},this.open=function(a){var b=this.get(a);b&&(b.type="open",this.clear(),this.render(!0),this.emit("open",[b]))},this.fold=function(a){var b=this.get(a);b&&(b.type="fold",this.clear(),this.render(!0),this.emit("fold",[b]))},this.openAll=function(a){var b=this.getAll(a);if(b){for(var c=0,d=b.length;d>c;c++)b[c].type="open";this.clear(),this.render(!0),this.emit("openall")}},this.foldAll=function(a){var b=this.getAll(a);if(b){for(var c=0,d=b.length;d>c;c++)b[c].type="fold";this.clear(),this.render(!0),this.emit("foldall")}},this.next=function(){var a=(z-1)*this.options.bufferCount,b=a+this.options.bufferCount;if("vscroll"==this.options.buffer&&(t.reset(),F.start_index<F.end_index&&(a=F.start_index,b=F.end_index)),b=b>w.length?w.length:b,b<=w.length){for(var c=[],d=a;b>d;d++){var e=w[d];e.reload(s.uit.getColumn()),c.push(e)}t.append(c),"vscroll"!=this.options.buffer&&(this.emit("next",[z]),c.length>0&&z++)}},this.page=function(a){return"scroll"==this.options.buffer||"vscroll"==this.options.buffer?!1:this.getPage()==a?!1:(this.clear(),z=1>a?1:a,void this.render())},this.sort=function(a,c,d,e){function f(){var a=b.sort(u);"desc"==i.order?a.setCompare(function(a,b){return g(a)>g(b)?!0:!1}):a.setCompare(function(a,b){return g(a)<g(b)?!0:!1}),a.run(),h.clear(),h.render(!0),h.emit("sortend",[i,d]),h.hideLoading()}function g(a){var b=a.data[i.name];return"string"==typeof b?b.toLowerCase():isNaN(b)||null==b?"":b}if(this.options.fields&&this.options.sort&&!B){var h=this,i=s.getColumn(a);"string"==typeof i.name&&(i.order=c?c:"asc"==i.order?"desc":"asc",s.uit.setColumn(a,i),this.options.sortLoading&&!e?(h.showLoading(),setTimeout(function(){f()},this.options.sortLoading)):f())}},this.filter=function(a){null==x?x=w:w=x;for(var b=w.slice(),c=[],d=0,e=b.length;e>d;d++){var f=b[d].data;("function"==typeof a&&a(f)===!0||!a)&&c.push(f)}this.update(c),this.emit("filter",[c])},this.rollback=function(){this.filter(null),x=null},this.clear=function(){z=1,t.uit.removeRows(),t.scroll()},this.reset=function(){"vscroll"==this.options.buffer&&o(this),this.clear(),u=[],v=[],w=[],D=null},this.resize=function(){s.resizeColumns(),s.resize(),s.emit("colresize")},this.scrollWidth=function(b,c){if(0!=this.options.scrollWidth){var d=this.options.width;if(d>0){var e=b>=d?b-l(this):d;a(this.root).outerWidth(e)}else a(this.root).outerWidth(b-l(this));if(b>0){var f=a(this.root).outerWidth();a(this.root).outerWidth(b),c&&(a(s.root).outerWidth(f+l(this)),a(t.root).outerWidth(f),k(1e3)),a(s.root).parent().css("max-width",b),a(t.root).parent().css("max-width",b)}}},this.scrollHeight=function(b){"page"!=this.options.buffer&&(a(this.root).find(".body").css("max-height",b+"px"),this.setOption("scrollHeight",b),i(this,this.options.scrollWidth,b))},this.scrollTop=function(c,d){if("vscroll"==this.options.buffer){var e=a(this.root).children(".body");r(this,!0);for(var f=0,g=w.length;g>f;f++){var h=w[f];if(""+c==h.index){F.prev_scroll_top=0,F.current_row_index=0;var i=f*F.height,j=e.height(),k=b.typeCheck("integer",d)?d:0;i+k>j&&(i+=k),e.scrollTop(i),this.clear(),this.next();break}}}},this.height=function(a){this.scrollHeight(a)},this.size=function(){return u.length},this.count=function(){return u.length},this.list=function(){return u},this.listColumn=function(){return s.listColumn()},this.listData=function(){for(var a=[],b=0;b<u.length;b++)a.push(u[b].data);return a},this.get=function(a){if(null==a)return null;var b=v[a];if(b)return b;for(var c=E.getIndexList(a),b=v[c[0]],d=1,e=c.length;e>d&&b;d++)b=b.children[c[d]];return b},this.getAll=function(a,c){var d=this.get(a);if(null!=d){b.typeCheck("array",c)||(c=[d]);for(var e=0;e<d.children.length;e++){var f=d.children[e];if(c.push(f),f.children.length>0)return this.getAll(f.index,c)}}return c},this.getColumn=function(a){return s.getColumn(a)},this.getData=function(a){var b=this.get(a);return b?b.data:null},this.showColumn=function(a){s.showColumn(a)},this.hideColumn=function(a){s.hideColumn(a)},this.initColumns=function(a){s.initColumns(a),t.initColumns(a),s.emit("colresize")},this.showColumnMenu=function(a,b){s.showColumnMenu(a,b)},this.hideColumnMenu=function(){s.hideColumnMenu()},this.toggleColumnMenu=function(a,b){s.toggleColumnMenu(a,b)},this.showExpand=function(a,b){t.showExpand(a,b)},this.hideExpand=function(a){a?t.hideExpand(a):t.hideExpand()},this.getExpand=function(){return t.getExpand()},this.showLoading=function(a){if(y&&!A&&(y.show(),A=!0,a>0)){var b=this;setTimeout(function(){b.hideLoading()},a)}},this.hideLoading=function(){y&&A&&(y.hide(),A=!1)},this.setCsv=function(a){var c=this.options;if(c.fields||c.csv){var d=b.getCsvFields(c.fields,c.csv),e=c.csvNumber?b.getCsvFields(c.fields,c.csvNumber):null;this.update(b.csvToData(d,a,e))}},this.setCsvFile=function(a){if(this.options.fields||this.options.csv){var c=this;b.fileToCsv(a,function(a){c.setCsv(a)})}},this.getCsv=function(){if(this.options.fields||this.options.csv){var a=b.getCsvFields(this.options.fields,this.options.csv),c=u.length>this.options.csvCount?this.options.csvCount:u.length;return b.dataToCsv2({fields:a,rows:this.listData(),count:c,names:this.options.csvNames})}},this.getCsvBase64=function(){return this.options.fields||this.options.csv?b.csvToBase64(this.getCsv()):void 0},this.downloadCsv=function(a){b.typeCheck("string",a)&&(a=a.split(".")[0]);var c=document.createElement("a");c.download=a?a+".csv":"table.csv",c.href=this.getCsvBase64(),document.body.appendChild(c),c.click(),c.parentNode.removeChild(c)},this.rowFunc=function(a,b,c){if(this.options.fields){var d="function"==typeof c?!0:!1,e=0,f=d?0:u.length,g=s.getColumn(b);if(g.name)for(var h=0;h<u.length;h++){var i=u[h].data,j=i[g.name];isNaN(j)||(d?c(u[h])&&(e+=j,f++):e+=j)}return"sum"==a?e:"avg"==a?e/f:null}},this.getPage=function(){return z-1},this.activeIndex=function(){return D?D.index:null}};return f.setup=function(){return{fields:null,csv:null,csvNames:null,csvNumber:null,csvCount:1e4,data:[],rows:null,colshow:!1,expand:!1,expandEvent:!0,resize:!1,rowHeight:26,scrollHeight:200,scrollWidth:0,width:0,buffer:"scroll",bufferCount:100,sort:!1,sortLoading:!1,sortCache:!1,sortIndex:null,sortOrder:"asc",sortEvent:!0,animate:!1}},f});